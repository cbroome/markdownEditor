(function(b){"function"===typeof define&&define.amd?define(["jquery"],b):b(jQuery)})(function(b){var g=0;b.fn.markdownEditor=function(a,d){return{init:b.proxy(b.fn.markdownEditor.init,this),destroy:b.proxy(b.fn.markdownEditor.destroy,this),getHTML:b.proxy(b.fn.markdownEditor.getHTML,this),getMarkdown:b.proxy(b.fn.markdownEditor.getMarkdown,this),setValue:b.proxy(b.fn.markdownEditor.setValue,this),addButton:b.proxy(b.fn.markdownEditor.addButton,this),addComponent:b.proxy(b.fn.markdownEditor.addComponent,
this),getSelection:b.proxy(b.fn.markdownEditor.getSelection,this),insertValueAtCursor:b.proxy(b.fn.markdownEditor.insertValueAtCursor,this)}[a](d)};b.fn.markdownEditor.init=function(a){a=new b.fn.markdownEditor.MarkdownEditor(this,a);a.render();this.data("markdownEditor",a);return this};b.fn.markdownEditor.destroy=function(){this.data("markdownEditor").destroy();this.removeData("markdownEditor")};b.fn.markdownEditor.getHTML=function(){return this.data("markdownEditor").getHTML()};b.fn.markdownEditor.getMarkdown=
function(){return this.data("markdownEditor").getMarkdown()};b.fn.markdownEditor.setValue=function(a){this.data("markdownEditor").setValue(a);return this};b.fn.markdownEditor.addButton=function(a){this.data("markdownEditor").addButton(a);return this};b.fn.markdownEditor.addComponent=function(a){return this.data("markdownEditor").addComponent(a)};b.fn.markdownEditor.getSelection=function(){return this.data("markdownEditor").getSelection()};b.fn.markdownEditor.insertValueAtCursor=function(a){this.data("markdownEditor").insertValueAtCursor(a);
return this};b.fn.markdownEditor.MarkdownEditor=function(a,b){this.setupEl(a);this.setupOptions(b);this.initialize()};b.extend(b.fn.markdownEditor.MarkdownEditor.prototype,{id:void 0,$textarea:void 0,$preview:void 0,$buttonBar:void 0,$el:void 0,options:void 0,_buttonBold:function(a){return"**"+a+"**"},_buttonItalic:function(a){return"*"+a+"*"},_buttonUnderline:function(a){return"_"+a+"_"},_buttonClick:function(a){var b=this.getSelection();a&&(a=a(b.selection),this.insertValueAtCursor(a))},_defaultButtons:function(){return[{label:"B",
name:"bold",functionality:this._buttonBold},{label:"I",name:"italic",functionality:this._buttonItalic},{label:"U",name:"underline",functionality:this._buttonUnderline}]},_updatePreview:function(){var a=this.$textarea.val(),d=/!!!UNIQUE_TOKEN!!!/,a=b("<div />").append(a),c=[],e;a.first().contents().each(function(){1===this.nodeType&&(c.push(b(this).clone().wrap("<p>").parent().html()),b(this).replaceWith("!!!UNIQUE_TOKEN!!!"))});for(e=markdown.toHTML(a.html());c.length;)a=c.shift(),e=e.replace(d,a);
this.$preview.html(e)},_createColumn:function(a){var d=b('<div class="md-column" />');a&&d.append(a);return d},_textareaBehavior:function(a){if(9===a.keyCode){var b=a.target.selectionStart,c=a.target.selectionEnd,e=this.$textarea.val();this.$textarea.val(e.substring(0,b)+"\t"+e.substring(c));a.target.selectionStart=a.target.selectionEnd=b+1;a.preventDefault()}},_buildButton:function(a){var d=b('<button type="button">'+a.label+"</button>");(functionality=a.functionality)&&d.click(b.proxy(this._buttonClick,
this,functionality));this.$buttonBar.append(d)},_buildButtonBar:function(){var a=this._defaultButtons(),b=a.length,c;for(c=0;c<b;c++)this._buildButton(a[c])},setupOptions:function(a){this.options={initString:void 0,markdownAttrs:void 0,previewAttrs:void 0};b.extend(this.options,a||{})},setupEl:function(a){this.$el=a},initialize:function(){this.id="md"+g++;this.options.initString=this.options.initString||decodeURI(this.$el.html())},render:function(){var a=b.proxy(this._updatePreview,this),d;this.$el.addClass("md-markdown-editor");
this.$textarea=b("<textarea />").val(this.options.initString);this.$buttonBar=b('<div class="md-button-bar" />');this.$preview=b('<div class="md-preview" />');this.$el.empty();this._buildButtonBar();d=this._createColumn();d.append(this.$buttonBar);d.append(this.$textarea);this.$el.append(d).append(this._createColumn(this.$preview));this.options.markdownAttrs&&this.$textarea.attr(this.options.markdownAttrs);this.options.previewAttrs&&this.$textarea.attr(this.options.previewAttrs);this.$textarea.on("input",
a).on("keyup",a).on("keydown",a);this.$textarea.keydown(b.proxy(this._textareaBehavior,this));this._updatePreview();return this},destroy:function(){this.$preview.remove();this.$preview=void 0;this.$textarea.remove();this.$textarea=void 0;this.$el.remove();this.$el=void 0},getMarkdown:function(){return this.$textarea.val()},getHTML:function(){return this.$preview.html()},setValue:function(a){this.$textarea.val(a);this._updatePreview();return this},addButton:function(a){this._buildButton(a);return this},
addComponent:function(a){this.$buttonBar.append(a)},getSelection:function(){var a,b,c;a=this.$textarea.val();b=this.$textarea[0].selectionStart;c=this.$textarea[0].selectionEnd;a=a.substring(b,c);return{start:b,end:c,selection:a}},insertValueAtCursor:function(a){var b,c,e,f;a&&(e=this.$textarea.val(),c=this.getSelection(),b=c.start||0,c=c.end||0,e=e.substring(0,b)+a+e.substring(c,e.length),this.$textarea.val(e),f=b+a.length,this.$textarea.focus(),this.$textarea.each(function(a,b){b.setSelectionRange(f,
f)}),this._updatePreview())}})});
